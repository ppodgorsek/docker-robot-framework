sudo: required

services:
  - docker

language: generic

env:
  global:
    - IMAGE=docker-robot-framework:ci
    - CACHE_FOLDER=$HOME/docker-images
    - CACHE_FILE=$CACHE_FOLDER/$NAME-$TRAVIS_COMMIT.tgz
  matrix:
    # test chrome
    - TEST_COMMAND='-e BROWSER=chrome'
    - TEST_COMMAND='-e BROWSER=chrome -e SCREEN_COLOUR_DEPTH=8'
    - TEST_COMMAND='-e BROWSER=chrome -e SCREEN_WIDTH=800 -e SCREEN_HEIGHT=600'
    - TEST_COMMAND='-e BROWSER=chrome -e SCREEN_WIDTH=1024 -e SCREEN_HEIGHT=768'
    - TEST_COMMAND='-e BROWSER=chrome -e SCREEN_WIDTH=1280 -e SCREEN_HEIGHT=1024'
    - TEST_COMMAND='-e BROWSER=chrome -e SCREEN_WIDTH=2560 -e SCREEN_HEIGHT=1440'
    - TEST_COMMAND='-e BROWSER=chrome -e SCREEN_WIDTH=3840 -e SCREEN_HEIGHT=2160'
    - TEST_COMMAND='-e BROWSER=chrome -e ROBOT_OPTIONS="--loglevel DEBUG"'
    - TEST_COMMAND='-e BROWSER=chrome -e ROBOT_THREADS=4'
    # test firefox  
    - TEST_COMMAND='-e BROWSER=firefox'
    - TEST_COMMAND='-e BROWSER=firefox -e SCREEN_COLOUR_DEPTH=8'
    - TEST_COMMAND='-e BROWSER=firefox -e SCREEN_WIDTH=800 -e SCREEN_HEIGHT=600'
    - TEST_COMMAND='-e BROWSER=firefox -e SCREEN_WIDTH=1024 -e SCREEN_HEIGHT=768'
    - TEST_COMMAND='-e BROWSER=firefox -e SCREEN_WIDTH=1280 -e SCREEN_HEIGHT=1024'
    - TEST_COMMAND='-e BROWSER=firefox -e SCREEN_WIDTH=2560 -e SCREEN_HEIGHT=1440'
    - TEST_COMMAND='-e BROWSER=firefox -e SCREEN_WIDTH=3840 -e SCREEN_HEIGHT=2160'
    - TEST_COMMAND='-e BROWSER=firefox -e ROBOT_OPTIONS="--loglevel DEBUG"'
    - TEST_COMMAND='-e BROWSER=firefox -e ROBOT_THREADS=4'
stages:
  - build
  - test
script:
  - ls -la $CACHE_FOLDER
  - if [[ -f $CACHE_FILE ]]; then docker load -i $CACHE_FILE; fi
  - docker run --shm-size=1g -v `pwd`/test:/opt/robotframework/tests:Z $TEST_COMMAND $IMAGE
jobs:
  include:
    - stage: build
      script:
        - docker build -t $IMAGE .
        - mkdir -p $CACHE_FOLDER
        - docker save $IMAGE | gzip -c > $CACHE_FILE

cache:
  bundler: true
  directories:
    - ${CACHE_FOLDER}